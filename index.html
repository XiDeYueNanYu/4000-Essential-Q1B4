<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Practice - Reading and Vocabulary</title>
<style>
    /* VARIABLES (KEEPING SIMILARITY WITH ORIGINAL CODE) */
    :root {
        --color1: #2a4d69;
        --color2: #ffffff;
        --color3: #181e1a;
        --color4: #f9f9f9;
        --color5: #234912;
        --color6: #263c1a;
        --color7: #181e1a;
        --color8: #4b7838;
        --color9: #000000;
        --color10: #698296;
        --color11: #263c1a;
        --color12: #181e1a;
        --structure-bg: #ff9e07;
        --structure-text: #181e1a;
        --dependent-bg: #ffd89b;
        --dependent-text: #181e1a;
        --dependent-underline: #de5046;

        /* New variables for Vocab mode */
        --vocab-bg: #f5f5f5;
        --vocab-border: #72a9db;
        --vocab-highlight: #63a0d8;
        --answer-bg: #ffffe0;
    }

    /* GENERAL STYLES - Modified for fixed bottom controls */
    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        padding: 0;
        background-color: #000000;
        font-family: Arial, 'Noto Sans SC', sans-serif;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        width: 100%;
        overflow-x: hidden;
        padding-bottom: 80px; /* Space for fixed mode controls */
    }
    
    .container {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        width: 100%;
        max-width: 1200px;
        position: relative;
    }

    /* READING MODE (CONTENT) STYLES */
    #readingMode {
        display: flex;
        width: 100%;
        flex-direction: column;
        align-items: center;
    }

    .text-box {
        width: 100%;
        max-width: 1100px;
        padding: 0;
        padding-top: 30px;
        border: clamp(5px, 1vw, 10px) solid var(--color1);
        border-radius: 0;
        background-color: var(--color4);
        font-size: 50px;
        color: var(--color3);
        text-align: justify;
        overflow-wrap: break-word;
        position: relative;
        word-wrap: break-word;
        hyphens: auto;
    }
    
    #textContent {
        font-size: 35px;
        border-radius: 0;
        white-space: pre-wrap;
        word-break: break-word;
        overflow-wrap: break-word;
        width: 100%;
        line-height: 4;
    }
    
    .translated-word, .ipa-word {
        position: relative;
        display: inline-block;
        white-space: nowrap;
        line-height: 1;
        background-color: rgba(75,120,56,0.1);
        color: var(--color5);
        padding: 0;
        margin: 0 1px;
    }
    
    .translation {
        position: absolute;
        bottom: 70px;
        left: 50%;
        transform: translateX(-50%);
        font-size: clamp(10px, 1.8vw, 13px);
        background-color: rgba(75,120,56,0.3);
        color: var(--color7);
        padding: clamp(5px, 0.8vw, 9px);
        border-radius: clamp(4px, 0.6vw, 7.5px);
        white-space: nowrap;
        z-index: 1;
        line-height: 1;
        max-width: clamp(150px, 25vw, 300px);
        word-wrap: break-word;
    }
    
    .ipa {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        font-size: clamp(12px, 1.8vw, 20px);
        background-color: rgba(75,120,56,0.1);
        color: var(--color12);
        padding: clamp(2px, 0.3vw, 3px) clamp(3px, 0.5vw, 5px);
        border-radius: clamp(4px, 0.6vw, 7.5px);
        white-space: nowrap;
        z-index: 1;
        line-height: 1;
        font-family: 'Arial', sans-serif;
    }
    
    .original {
        display: inline;
        line-height: 1;
    }

    /* AUDIO CONTROLS (Floating) - RESTORING ORIGINAL LAYOUT/STYLES */
    .floating-controls {
        position: fixed;
                top: auto;
        bottom: 20px;
        right: 20px;
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        text-align: center;
        display: block;
        z-index: 1000;
        width: 90%;
        max-width: 300px;
    }
    
    /* N√öT HI·ªÇN TH·ªä KHI ƒêANG THU G·ªåN */
    #showControlsButton {
        display: none; /* Ban ƒë·∫ßu ·∫©n */
        position: fixed;
        top: auto;
                bottom: 50px;
        right: 20px;
        width: 60px;
        height: 60px;
        background-color: #4682B4; 
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        z-index: 1001; /* Cao h∆°n floating-controls */
    }
    
    #showControlsButton:hover {
        background-color: #36648B;
    }

    #audioPlayer {
        width: 100%;
        margin-bottom: 10px;
    }
    
    .time-row {
        display: flex;
        justify-content: space-around;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    
    .time-box-group {
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    
    .button-group {
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    
    .floating-controls p#timeDisplay {
        font-size: 28px;
        color: #FFFFFF;
        background-color: #000000;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        margin: 0;
    }
    
    .floating-controls .time-box {
        font-size: 16px;
        color: #FFFFFF;
        background-color: #555555;
        padding: 5px 10px;
        border-radius: 5px;
        min-width: 60px;
        text-align: center;
    }
    
    .tua-buttons {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }
    
    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    
    .control-button {
        width: 50px;
        height: 50px;
        background-color: #363535;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        display: inline-flex;
        justify-content: center;
        align-items: center;
    }
    
    .control-button:disabled {
        background-color: #888888;
        cursor: not-allowed;
    }
    
    .control-button:hover:not(:disabled) {
        background-color: #000000;
    }
    
    .pause-play-button {
        background-color: #FF4500;
    }
    
    .pause-play-button:hover {
        background-color: #CC3700;
    }
    
    .toggle-button {
        background-color: #4682B4;
    }
    
    .toggle-button:hover {
        background-color: #36648B;
    }
    
    .loop-button {
        background-color: #3c923c;
    }
    
    .loop-button:hover {
        background-color: #347d34;
    }
    
    .clear-button {
        background-color: #bc3f13;
    }
    
    .clear-button:hover {
        background-color: #d15124;
    }

    /* VOCABULARY MODE STYLES */
    #vocabMode {
        display: none;
        width: 95%;
        max-width: 700px;
        margin: 20px auto;
        padding-top: 30px;
        position: relative;
    }

    .vocab-nav-bar {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    #vocabIndex {
        font-size: 24px;
        font-weight: bold;
        color: var(--vocab-highlight);
    }

    #vocabReplayBtn {
        padding: 5px 10px;
        font-size: 20px;
        cursor: pointer;
        background-color: var(--vocab-highlight);
        color: white;
        border: none;
        border-radius: 5px;
    }

    .vocab-box {
        margin: 15px auto;
        padding: 15px;
        border: 3px solid var(--vocab-border);
        border-radius: 5px;
        display: flex;
        flex-wrap: wrap;
        /* S·ª¨A L·ªñI: ƒê·∫∑t gap=0 ƒë·ªÉ c√°c k√Ω t·ª± d√≠nh v√†o nhau */
        gap: 0px; 
        justify-content: center;
        align-items: center;
        font-size: clamp(32px, 5vw, 48px);
        font-weight: bold;
        text-align: center;
        min-height: 80px;
    }

    #ipaDisplayVocab {
        background: #ffffe0;
        color: var(--color1);
        border-color: #fed16a;
    }

    #selectedLetters {
        background: var(--answer-bg);
        border-color: #ccc;
        transition: all .4s;
    }

    #selectedLetters.correct {
        background: #B7D7AA !important;
        border-color: #5ba346;
    }

    #selectedLetters.wrong {
        background: #ffcccc !important;
        border-color: #CE6D5E;
    }

    #letterPool {
        background: var(--vocab-bg);
        border-color: var(--vocab-border);
        min-height: 100px;
        gap: 30px; /* Gi·ªØ gap cho khu v·ª±c l·ª±a ch·ªçn */
    }

    .letter-btn {
        padding: 10px 15px;
        background: white;
        border: 2px solid var(--vocab-highlight);
        border-radius: 8px;
        font-size: clamp(50px, 4vw, 60px);
        cursor: pointer;
        user-select: none;
        box-shadow: 0 2px 4px rgba(0,0,0,.1);
        transition: all .1s;
        min-width: 70px;
    }

    .letter-btn:active {
        transform: scale(0.95);
    }

    .letter-btn.used {
        opacity: 0.35;
        /* ƒê√É S·ª¨A: B·ªè pointer-events: none ƒë·ªÉ cho ph√©p nh·∫•n l·∫°i v√†o n√∫t ƒë√£ m·ªù */
    }

    .letter-btn-in-answer {
        background: #ffd700 !important;
        animation: pop .2s;
        /* S·ª¨A L·ªñI: ƒê·∫∑t margin = 0 ƒë·ªÉ ki·ªÉm so√°t b·∫±ng gap c·ªßa cha (ƒë√£ ƒë·∫∑t gap=0) */
        margin: 0 0px;
                border: 0px;
                border-radius: 2px;
                padding: 3px;
                min-width: 20px;
    }
    
    @keyframes pop {
        0% { transform: scale(0.8); }
        100% { transform: scale(1); }
    }

    /* FIXED BOTTOM CONTROLS (MODE SWITCHER) - ƒê√É CƒÇN GI·ªÆA */
    .fixed-bottom-controls {
        position: fixed;
        bottom: 0;
        
        /* CƒÇN GI·ªÆA KHUNG CH·ª®A */
        left: 50%; 
        transform: translateX(-50%); 
        max-width: 400px; /* Gi·ªõi h·∫°n ƒë·ªô r·ªông t·ªëi ƒëa */
        width: 100%; 
        
        background: #ffffff;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        z-index: 2000;
    }

    .mode-btn {
        padding: 10px 20px;
        font-size: 22px;
        cursor: pointer;
        border: 2px solid var(--vocab-highlight);
        background: white;
        color: var(--vocab-highlight);
        border-radius: 8px;
        flex: 1;
        margin: 0 5px;
        font-weight: bold;
    }

    .mode-btn.active-mode {
        background: var(--vocab-highlight);
        color: white;
    }

    /* MEDIA QUERIES */
    @media (max-width: 768px) { 
        body {
            padding-bottom: 70px;
        }
        
        .floating-controls {
            position: fixed;
            top: auto;
                        bottom: 80px;
            right: 10px;
            width: 50%;
            max-width: none;
        }
        
        #showControlsButton {
            top: auto;
                        bottom: 100px;
            right: 10px;
            width: 50px;
            height: 50px;
            font-size: 16px;
        }

        #textContent {
            line-height: 3.8;
            font-size: 22px;
        }
        
        .ipa {
            top: -20px;
            font-size: 14px;
        }
        
        .translation {
            bottom: 45px;
            font-size: 10px;
        }

        .mode-btn {
            font-size: 18px;
            padding: 8px 15px;
        }
        
        .letter-btn {
            font-size: 50px;
            padding: 8px 12px;
        }
        .letter-btn-in-answer {
        font-size: 35px; /* Gi·ªØ nguy√™n k√≠ch th∆∞·ªõc ch·ªØ */
                border: 0px;
                border-radius: 0px;
                padding: 1px 1px;
                min-width: 20px;
                }
        .control-button {
            width: 40px;
            height: 40px;
            font-size: 14px;
        }
        
        .floating-controls p#timeDisplay {
            font-size: 20px;
        }
    }
</style>
</head>
<body>
    <div class="container">
        
        <div id="readingMode">
            <div class="text-box" id="textDisplay">
                <div id="textContent"></div>
            </div>
            
        </div>

        <div class="floating-controls" id="floatingControls">
            <audio id="audioPlayer" src="lesson.mp3" controls></audio>
            
            <div class="time-row">
                <p id="timeDisplay">00:00</p>
                <div class="time-box-group">
                    <span class="time-box" id="loopStart">--:--</span>
                    <span class="time-box" id="loopEnd">--:--</span>
                </div>
                <div class="button-group">
                    <button class="control-button loop-button" id="loopButton">Âê¨</button>
                    <button class="control-button clear-button" id="clearButton">Âà†</button>
                </div>
            </div>
            
            <div class="tua-buttons">
                <button class="control-button" id="rewind5sButton">-5s</button>
                <button class="control-button" id="rewind1sButton">-1s</button>
                <button class="control-button" id="forward1sButton">+1s</button>
                <button class="control-button" id="forward5sButton">+5s</button>
            </div>
            
            <div class="action-buttons" id="fullControls">
                <button class="control-button pause-play-button" id="pausePlayButton">Êí≠</button>
                <button class="control-button toggle-button" id="toggleControlsButton">Ëóè</button>
            </div>
        </div>

        <button id="showControlsButton">Á§∫</button> 

        <div id="vocabMode">
            <div class="vocab-nav-bar">
                <button id="vocabPrevBtn">‚óÄ</button>
                <span id="vocabIndex">1/N</span>
                <button id="vocabNextBtn">‚ñ∂</button>
                <button id="vocabReplayBtn">üéß</button>
            </div>
            
            <div id="ipaDisplayVocab" class="vocab-box">/IPA/</div>

            <div id="selectedLetters" class="vocab-box"></div>

            <div id="letterPool" class="vocab-box"></div>
        </div>

    </div>

    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <div class="fixed-bottom-controls">
        <button id="contentModeBtn" class="mode-btn active-mode">N·ªôi dung</button>
        <button id="vocabModeBtn" class="mode-btn">Luy·ªán t·ª´</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // =================================================================================
        //                                      PH·∫¶N D·ªÆ LI·ªÜU
        // =================================================================================

const textContentData = [
            `The Dog‚Äôs BellÔºö         
John‚Äôs dog was a bad dog. He bit people frequently. John had great concern about this. It was not an appropriate way for a dog to behave. His friends in the village always expected the dog to bite them. The news about John‚Äôs dog spread through the village. None of the people wanted to go to John‚Äôs house. John tried to instruct the dog to behave, but it never worked. He tried to be patient and teach the dog to be calm. That also didn‚Äôt work. John didn‚Äôt want to punish the dog. ‚ÄúHow will I stop my dog‚Äôs bad habit?‚Äù John asked himself.
John‚Äôs friend came to talk to him about the issue. During their important meeting, his friend said, ‚ÄúThe people in the village asked me to represent them. We want your dog to stop this habit. Why don‚Äôt you put a bell around the dog‚Äôs neck? This way, we would hear your dog coming down the street.‚Äù
John thought this was a great idea. Now, people could stay away from the dog. It would not be able to bite anyone anymore.
The dog liked the bell, too. People looked at him when they heard his bell. This made the dog very content. He liked the song the bell played when he walked.
One day, John‚Äôs dog strolled through the village and met some other dogs. He expected them to want a bell like his. But they laughed at his bell. They said the bell made people avoid him. John‚Äôs dog shook his head. ‚ÄúNo, they look at me because they like the bell.‚Äù
The other dogs said, ‚ÄúYou have the wrong idea of what makes you popular. Of course they like your bell. It tells them where you are so they can avoid you. You aren‚Äôt able to bite them anymore!‚Äù
You see, being popular isn‚Äôt something positive when it‚Äôs for the wrong reason.
                        `
        ];const dictionary = {
    "frequently": "È¢ëÁπÅÂú∞",
    "concern": "ÊãÖÂøß",
    "appropriate": "ÂêàÈÄÇÁöÑ",
    "behave": "Ë°®Áé∞",
    "expected": "È¢ÑÊñô",
    "spread": "‰º†Êí≠",
    "instruct": "ÊïôÂØº",
    "patient": "ËÄêÂøÉÁöÑ",
    "punish": "ÊÉ©ÁΩö",
    "habit": "‰π†ÊÉØ",
    "issue": "ÈóÆÈ¢ò",
    "important": "ÈáçË¶ÅÁöÑ",
    "represent": "‰ª£Ë°®",
    "neck": "ËÑñÂ≠ê",
    "content": "Êª°Ë∂≥ÁöÑ",
    "strolled": "Êï£Ê≠•",
    "avoid": "ÈÅøÂºÄ",
    "popular": "ÂèóÊ¨¢ËøéÁöÑ",
    "positive": "ÁßØÊûÅÁöÑ",
    "reason": "ÂéüÂõ†",
    "bell": "ÈìÉÈìõ",
    "village": "ÊùëÂ∫Ñ",
    "news": "Ê∂àÊÅØ",
    "calm": "ÂÜ∑ÈùôÁöÑ",
    "idea": "‰∏ªÊÑè",
    "street": "Ë°óÈÅì",
    "song": "Ê≠åÊõ≤",
    "played": "Êí≠Êîæ",
    "laughed": "Âò≤Á¨ë",
    "wrong": "ÈîôËØØÁöÑ",
    "bit": "Âí¨",
    "people": "‰∫∫‰ª¨",
    "friends": "ÊúãÂèã‰ª¨",
    "always": "ÊÄªÊòØ",
    "tried": "Â∞ùËØï",
    "never": "‰ªé‰∏ç",
    "worked": "Ëµ∑‰ΩúÁî®",
    "asked": "ÈóÆ",
    "himself": "‰ªñËá™Â∑±",
    "during": "Âú®...ÊúüÈó¥",
    "meeting": "‰ºöËÆÆ",
    "around": "Âõ¥Áªï",
    "coming": "Êù•",
    "stay": "‰øùÊåÅ",
    "away": "ËøúÁ¶ª",
    "anymore": "ÂÜç",
    "looked": "Áúã",
    "heard": "Âê¨Âà∞",
    "shook": "Êëá",
    "course": "ÂΩìÁÑ∂",
    "bad": "ÂùèÁöÑ",
    "great": "ÂæàÂ§ßÁöÑ",
    "none": "Ê≤°Êúâ‰∫∫",
    "house": "ÊàøÂ≠ê",
    "stop": "ÂÅúÊ≠¢",
    "put": "Êîæ",
    "heard": "Âê¨Âà∞",
    "able": "ËÉΩÂ§ü",
    "walked": "Ëµ∞",
    "met": "ÈÅáÂà∞",
    "other": "ÂÖ∂‰ªñÁöÑ"
}; const englishWordsArray = [
    "The", "Dog‚Äôs", "Bell", "John‚Äôs", "dog", "was", "a", "bad", "dog", "He", "bit", "people", "frequently", "John", "had", "great", "concern", "about", "this", "It", "was", "not", "an", "appropriate", "way", "for", "a", "dog", "to", "behave", "His", "friends", "in", "the", "village", "always", "expected", "the", "dog", "to", "bite", "them", "The", "news", "about", "John‚Äôs", "dog", "spread", "through", "the", "village", "None", "of", "the", "people", "wanted", "to", "go", "to", "John‚Äôs", "house", "John", "tried", "to", "instruct", "the", "dog", "to", "behave", "but", "it", "never", "worked", "He", "tried", "to", "be", "patient", "and", "teach", "the", "dog", "to", "be", "calm", "That", "also", "didn‚Äôt", "work", "John", "didn‚Äôt", "want", "to", "punish", "the", "dog", "How", "will", "I", "stop", "my", "dog‚Äôs", "bad", "habit", "John", "asked", "himself", "John‚Äôs", "friend", "came", "to", "talk", "to", "him", "about", "the", "issue", "During", "their", "important", "meeting", "his", "friend", "said", "The", "people", "in", "the", "village", "asked", "me", "to", "represent", "them", "We", "want", "your", "dog", "to", "stop", "this", "habit", "Why", "don‚Äôt", "you", "put", "a", "bell", "around", "the", "dog‚Äôs", "neck", "This", "way", "we", "would", "hear", "your", "dog", "coming", "down", "the", "street", "John", "thought", "this", "was", "a", "great", "idea", "Now", "people", "could", "stay", "away", "from", "the", "dog", "It", "would", "not", "be", "able", "to", "bite", "anyone", "anymore", "The", "dog", "liked", "the", "bell", "too", "People", "looked", "at", "him", "when", "they", "heard", "his", "bell", "This", "made", "the", "dog", "very", "content", "He", "liked", "the", "song", "the", "bell", "played", "when", "he", "walked", "One", "day", "John‚Äôs", "dog", "strolled", "through", "the", "village", "and", "met", "some", "other", "dogs", "He", "expected", "them", "to", "want", "a", "bell", "like", "his", "But", "they", "laughed", "at", "his", "bell", "They", "said", "the", "bell", "made", "people", "avoid", "him", "John‚Äôs", "dog", "shook", "his", "head", "No", "they", "look", "at", "me", "because", "they", "like", "the", "bell", "The", "other", "dogs", "said", "You", "have", "the", "wrong", "idea", "of", "what", "makes", "you", "popular", "Of", "course", "they", "like", "your", "bell", "It", "tells", "them", "where", "you", "are", "so", "they", "can", "avoid", "you", "You", "aren‚Äôt", "able", "to", "bite", "them", "anymore", "You", "see", "being", "popular", "isn‚Äôt", "something", "positive", "when", "it‚Äôs", "for", "the", "wrong", "reason"
];const ipaArray = [
    "/√∞…ô/", "/d…í…°z/", "/bel/", "/d í…ínz/", "/d…í…°/", "/w…íz/", "/…ô/", "/b√¶d/", "/d…í…°/", "/hiÀê/", "/b…™t/", "/ÀàpiÀêpl/", "/ÀàfriÀêkw…ôntli/", "/d í…ín/", "/h√¶d/", "/…°re…™t/", "/k…ônÀàs…úÀên/", "/…ôÀàba ät/", "/√∞…™s/", "/…™t/", "/w…íz/", "/n…ít/", "/…ôn/", "/…ôÀàpr…ô äpri…ôt/", "/we…™/", "/f…ô/", "/…ô/", "/d…í…°/", "/t…ô/", "/b…™Ààhe…™v/", "/h…™z/", "/frendz/", "/…™n/", "/√∞…ô/", "/Ààv…™l…™d í/", "/Àà…îÀêlwe…™z/", "/…™kÀàspekt…™d/", "/√∞…ô/", "/d…í…°/", "/t…ô/", "/ba…™t/", "/√∞…ôm/", "/√∞…ô/", "/njuÀêz/", "/…ôÀàba ät/", "/d í…ínz/", "/d…í…°/", "/spred/", "/Œ∏ruÀê/", "/√∞…ô/", "/Ààv…™l…™d í/", "/n ån/", "/…ôv/", "/√∞…ô/", "/ÀàpiÀêpl/", "/Ààw…ínt…™d/", "/t…ô/", "/…°…ô ä/", "/t…ô/", "/d í…ínz/", "/ha äs/", "/d í…ín/", "/tra…™d/", "/t…ô/", "/…™nÀàstr åkt/", "/√∞…ô/", "/d…í…°/", "/t…ô/", "/b…™Ààhe…™v/", "/b åt/", "/…™t/", "/Àànev…ô/", "/w…úÀêkt/", "/hiÀê/", "/tra…™d/", "/t…ô/", "/biÀê/", "/Ààpe…™ Ént/", "/…ônd/", "/tiÀêt É/", "/√∞…ô/", "/d…í…°/", "/t…ô/", "/biÀê/", "/k…ëÀêm/", "/√∞√¶t/", "/Àà…îÀêls…ô ä/", "/Ààd…™dnt/", "/w…úÀêk/", "/d í…ín/", "/Ààd…™dnt/", "/w…ínt/", "/t…ô/", "/Ààp ån…™ É/", "/√∞…ô/", "/d…í…°/", "/ha ä/", "/w…™l/", "/a…™/", "/st…íp/", "/ma…™/", "/d…í…°z/", "/b√¶d/", "/Ààh√¶b…™t/", "/d í…ín/", "/…ëÀêskt/", "/h…™mÀàself/", "/d í…ínz/", "/frend/", "/ke…™m/", "/t…ô/", "/t…îÀêk/", "/t…ô/", "/h…™m/", "/…ôÀàba ät/", "/√∞…ô/", "/Àà…™ ÉuÀê/", "/Ààdj ä…ôr…™≈ã/", "/√∞e…ô/", "/…™mÀàp…îÀêtnt/", "/ÀàmiÀêt…™≈ã/", "/h…™z/", "/frend/", "/sed/", "/√∞…ô/", "/ÀàpiÀêpl/", "/…™n/", "/√∞…ô/", "/Ààv…™l…™d í/", "/…ëÀêskt/", "/miÀê/", "/t…ô/", "/Àårepr…™Ààzent/", "/√∞…ôm/", "/wiÀê/", "/w…ínt/", "/j…îÀê/", "/d…í…°/", "/t…ô/", "/st…íp/", "/√∞…™s/", "/Ààh√¶b…™t/", "/wa…™/", "/d…ô änt/", "/juÀê/", "/p ät/", "/…ô/", "/bel/", "/…ôÀàra änd/", "/√∞…ô/", "/d…í…°z/", "/nek/", "/√∞…™s/", "/we…™/", "/wiÀê/", "/w äd/", "/h…™…ô/", "/j…îÀê/", "/d…í…°/", "/Ààk åm…™≈ã/", "/da än/", "/√∞…ô/", "/striÀêt/", "/d í…ín/", "/Œ∏…îÀêt/", "/√∞…™s/", "/w…íz/", "/…ô/", "/…°re…™t/", "/a…™Ààd…™…ô/", "/na ä/", "/ÀàpiÀêpl/", "/k äd/", "/ste…™/", "/…ôÀàwe…™/", "/fr…ôm/", "/√∞…ô/", "/d…í…°/", "/…™t/", "/w äd/", "/n…ít/", "/biÀê/", "/Ààe…™bl/", "/t…ô/", "/ba…™t/", "/Ààeniw ån/", "/ÀåeniÀàm…îÀê/", "/√∞…ô/", "/d…í…°/", "/la…™kt/", "/√∞…ô/", "/bel/", "/tuÀê/", "/ÀàpiÀêpl/", "/l äkt/", "/…ôt/", "/h…™m/", "/wen/", "/√∞e…™/", "/h…úÀêd/", "/h…™z/", "/bel/", "/√∞…™s/", "/me…™d/", "/√∞…ô/", "/d…í…°/", "/Ààveri/", "/k…ônÀàtent/", "/hiÀê/", "/la…™kt/", "/√∞…ô/", "/s…í≈ã/", "/√∞…ô/", "/bel/", "/ple…™d/", "/wen/", "/hiÀê/", "/w…îÀêkt/", "/w ån/", "/de…™/", "/d í…ínz/", "/d…í…°/", "/str…ô äld/", "/Œ∏ruÀê/", "/√∞…ô/", "/Ààv…™l…™d í/", "/…ônd/", "/met/", "/s åm/", "/Àà å√∞…ô/", "/d…í…°z/", "/hiÀê/", "/…™kÀàspekt…™d/", "/√∞…ôm/", "/t…ô/", "/w…ínt/", "/…ô/", "/bel/", "/la…™k/", "/h…™z/", "/b åt/", "/√∞e…™/", "/l…ëÀêft/", "/…ôt/", "/h…™z/", "/bel/", "/√∞e…™/", "/sed/", "/√∞…ô/", "/bel/", "/me…™d/", "/ÀàpiÀêpl/", "/…ôÀàv…î…™d/", "/h…™m/", "/d í…ínz/", "/d…í…°/", "/ É äk/", "/h…™z/", "/hed/", "/n…ô ä/", "/√∞e…™/", "/l äk/", "/…ôt/", "/miÀê/", "/b…™Ààk…íz/", "/√∞e…™/", "/la…™k/", "/√∞…ô/", "/bel/", "/√∞…ô/", "/Àà å√∞…ô/", "/d…í…°z/", "/sed/", "/juÀê/", "/h√¶v/", "/√∞…ô/", "/r…í≈ã/", "/a…™Ààd…™…ô/", "/…ôv/", "/w…ít/", "/me…™ks/", "/juÀê/", "/Ààp…ípj…ôl…ô/", "/…ôv/", "/k…îÀês/", "/√∞e…™/", "/la…™k/", "/j…îÀê/", "/bel/", "/…™t/", "/telz/", "/√∞…ôm/", "/we…ô/", "/juÀê/", "/…ëÀê/", "/s…ô ä/", "/√∞e…™/", "/k√¶n/", "/…ôÀàv…î…™d/", "/juÀê/", "/juÀê/", "/…ëÀênt/", "/Ààe…™bl/", "/t…ô/", "/ba…™t/", "/√∞…ôm/", "/ÀåeniÀàm…îÀê/", "/juÀê/", "/siÀê/", "/ÀàbiÀê…™≈ã/", "/Ààp…ípj…ôl…ô/", "/Àà…™znt/", "/Ààs åmŒ∏…™≈ã/", "/Ààp…íz…ôt…™v/", "/wen/", "/…™ts/", "/f…ô/", "/√∞…ô/", "/r…í≈ã/", "/ÀàriÀêzn/"
];

        // T·∫†O M·∫¢NG T·ª™ V·ª∞NG M·ªöI: Bao g·ªìm t·∫•t c·∫£ c√°c t·ª´ v√† t·ª´ l·∫∑p l·∫°i
        const uniqueVocab = englishWordsArray.map(word => word.replace(/‚Äô/g, "'").toLowerCase());

        // T·∫°o ƒë·ªëi t∆∞·ª£ng √°nh x·∫° t·ª´ chu·∫©n h√≥a ƒë·∫øn IPA ƒë·∫ßu ti√™n
        const wordToIPA = {};
        englishWordsArray.forEach((word, index) => {
            const normalizedWord = word.replace(/‚Äô/g, "'").toLowerCase();
            if (!wordToIPA[normalizedWord]) {
                wordToIPA[normalizedWord] = ipaArray[index];
            }
        });


        // =================================================================================
        //                                      BI·∫æN V√Ä ELEMENT
        // =================================================================================
        const textDisplay = document.getElementById('textDisplay');
        const textContent = document.getElementById('textContent');
        const contentModeBtn = document.getElementById('contentModeBtn');
        const vocabModeBtn = document.getElementById('vocabModeBtn');
        const readingModeDiv = document.getElementById('readingMode');
        const vocabModeDiv = document.getElementById('vocabMode');
        const floatingControls = document.getElementById('floatingControls'); // Element ƒëi·ªÅu khi·ªÉn audio

        // Vocab Mode Elements
        const vocabPrevBtn = document.getElementById('vocabPrevBtn');
        const vocabNextBtn = document.getElementById('vocabNextBtn');
        const vocabReplayBtn = document.getElementById('vocabReplayBtn');
        const vocabIndexSpan = document.getElementById('vocabIndex');
        const ipaDisplayVocab = document.getElementById('ipaDisplayVocab');
        const selectedLettersDiv = document.getElementById('selectedLetters');
        const letterPoolDiv = document.getElementById('letterPool');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');

        // Audio Elements (Reading Mode) - gi·ªØ l·∫°i logic ƒë·∫ßy ƒë·ªß
        const audioPlayer = document.getElementById("audioPlayer");
        const timeDisplay = document.getElementById("timeDisplay");
        const loopStart = document.getElementById("loopStart");
        const loopEnd = document.getElementById("loopEnd");
        const loopButton = document.getElementById("loopButton");
        const clearButton = document.getElementById("clearButton");
        const rewind5sButton = document.getElementById("rewind5sButton");
        const rewind1sButton = document.getElementById("rewind1sButton");
        const forward1sButton = document.getElementById("forward1sButton");
        const forward5sButton = document.getElementById("forward5sButton");
        const pausePlayButton = document.getElementById("pausePlayButton");
        // N√∫t Toggle c≈© (ƒë√£ ƒë∆∞·ª£c ƒë·ªïi logic)
        const toggleControlsButton = document.getElementById("toggleControlsButton");
        // N√∫t m·ªõi cho tr·∫°ng th√°i thu g·ªçn
        const showControlsButton = document.getElementById('showControlsButton');

        
        const horizontalPadding = 20;
        const verticalPadding = 300;
        
        let currentMode = 'reading'; // 'reading' or 'vocab'
        let currentVocabIndex = 0;
        // C·∫£i ti·∫øn: L∆∞u tr·ªØ ID duy nh·∫•t c·ªßa n√∫t Pool ƒë√£ ƒë∆∞·ª£c ch·ªçn
        let selectedLetters = []; 
        let isChecking = false;

        // BI·∫æN M·ªöI: L∆∞u tr·∫°ng th√°i hi·ªÉn th·ªã c·ªßa Audio Controls
        let isControlsHidden = true; // M·∫∑c ƒë·ªãnh ·∫©n (hi·ªÉn th·ªã n√∫t "Á§∫")
        // BI·∫æN M·ªöI: L∆∞u v·ªã tr√≠ cu·ªôn
        let scrollPosition = 0;

        // =================================================================================
        //                                      CH·ª®C NƒÇNG CHUNG
        // =================================================================================

        function shuffleArray(a) {
            const arr = [...a];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1)); 
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function applyPadding() {
            textContent.style.paddingLeft = `${horizontalPadding}px`;
            textContent.style.paddingRight = `${horizontalPadding}px`;
            textContent.style.paddingTop = `${verticalPadding}px`;
            textContent.style.paddingBottom = `${verticalPadding}px`;
        }
        
        // H√ÄM M·ªöI: C·∫≠p nh·∫≠t hi·ªÉn th·ªã Audio Controls d·ª±a tr√™n bi·∫øn tr·∫°ng th√°i
        function updateAudioControlsDisplay() {
            if (isControlsHidden) {
                floatingControls.style.display = 'none';
                showControlsButton.style.display = 'flex';
                toggleControlsButton.textContent = 'Ëóè'; // Gi·ªØ nguy√™n ch·ªØ
            } else {
                floatingControls.style.display = 'block';
                showControlsButton.style.display = 'none';
                toggleControlsButton.textContent = 'Á§∫'; // Gi·ªØ nguy√™n ch·ªØ
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            if (mode === 'reading') {
                readingModeDiv.style.display = 'flex';
                vocabModeDiv.style.display = 'none';
                
                // 1. Kh√¥i ph·ª•c tr·∫°ng th√°i Audio Controls
                updateAudioControlsDisplay(); 
                
                // 2. Kh√¥i ph·ª•c v·ªã tr√≠ cu·ªôn
                setTimeout(() => {
                    window.scrollTo(0, scrollPosition);
                }, 0); 

                contentModeBtn.classList.add('active-mode');
                vocabModeBtn.classList.remove('active-mode');
            } else if (mode === 'vocab') {
                
                // 3. L∆∞u v·ªã tr√≠ cu·ªôn hi·ªán t·∫°i tr∆∞·ªõc khi ·∫©n n·ªôi dung
                scrollPosition = window.scrollY; 
                
                readingModeDiv.style.display = 'none';
                vocabModeDiv.style.display = 'block';
                
                // ·∫®n audio controls v√† n√∫t thu g·ªçn khi v√†o Vocab mode
                floatingControls.style.display = 'none'; 
                showControlsButton.style.display = 'none'; 
                
                // T·∫Øt audio n·∫øu ƒëang b·∫≠t
                audioPlayer.pause();
                
                // Kh·ªüi t·∫°o ch·∫ø ƒë·ªô luy·ªán t·ª´
                initializeVocabMode();
                
                contentModeBtn.classList.remove('active-mode');
                vocabModeBtn.classList.add('active-mode');
            }
        }
        
        // Th√™m event listener ƒë·ªÉ l∆∞u v·ªã tr√≠ cu·ªôn khi ng∆∞·ªùi d√πng cu·ªôn (ch·ªâ trong Reading Mode)
        window.addEventListener('scroll', () => {
            if (currentMode === 'reading') {
                scrollPosition = window.scrollY;
            }
        });


        // =================================================================================
        //                                      PH·∫¶N READING MODE (N·ªôi dung)
        // =================================================================================

        // H√†m chu·∫©n h√≥a t·ª´ (ƒê√£ s·ª≠a t·ª´ m√£ tr∆∞·ªõc)
        function normalizeWord(word) {
            let cleanedWord = word.replace(/‚Äô/g, "'");
            return cleanedWord.replace(/^[^\w']+|[.,!?;:"\)]+$/g, '').toLowerCase();
        }

        const normalizedWordToIndices = {};
        englishWordsArray.map(word => normalizeWord(word)).forEach((word, index) => {
            if (!normalizedWordToIndices[word]) {
                normalizedWordToIndices[word] = [];
            }
            normalizedWordToIndices[word].push(index);
        });
        
        const wordUsageCount = {};

        function getNextWordIndex(normalizedWord) {
            if (!normalizedWordToIndices[normalizedWord]) {
                return undefined;
            }

            if (!wordUsageCount[normalizedWord]) {
                wordUsageCount[normalizedWord] = 0;
            }

            const currentCount = wordUsageCount[normalizedWord];
            const indices = normalizedWordToIndices[normalizedWord];

            if (currentCount < indices.length) {
                const index = indices[currentCount];
                wordUsageCount[normalizedWord]++;
                return index;
            }
            return undefined;
        }

        function renderText(text) {
            let result = '';
            let i = 0;
            
            Object.keys(wordUsageCount).forEach(key => wordUsageCount[key] = 0);
            
            let trimmedText = text.trimStart();
            let startSpaceLength = text.length - trimmedText.length;
            if (startSpaceLength > 0) {
                result += text.substring(0, startSpaceLength).replace(/\n/g, '<br>').replace(/\s/g, '&nbsp;');
                i += startSpaceLength;
            }
            text = trimmedText;

            while (i < text.length) {
                let matched = false;
                
                const wordRegex = /^([\w'‚Äô-]+)([.,!?;:"\)]?)(\s*)/i;
                const wordMatch = text.slice(i).match(wordRegex);
                    
                if (wordMatch) {
                    const wordPart = wordMatch[1]; 
                    const punctuationPart = wordMatch[2]; 
                    const spacePart = wordMatch[3]; 
                    const fullToken = wordMatch[0];
                        
                    const normalizedWord = normalizeWord(wordPart); 
                    const wordPosInArray = getNextWordIndex(normalizedWord);
                        
                    let wordHtml = '';
                        
                    if (dictionary[normalizedWord]) {
                        const translationText = dictionary[normalizedWord].replace(/\n/g, '<br>');
                            
                        if (wordPosInArray !== undefined) {
                            wordHtml = `<span class="translated-word"><span class="translation">${translationText}</span><span class="ipa-word"><span class="ipa">${ipaArray[wordPosInArray]}</span><span class="original">${wordPart}${punctuationPart}</span></span></span>`;
                        } else {
                            wordHtml = `<span class="translated-word"><span class="translation">${translationText}</span>${wordPart}${punctuationPart}</span>`;
                        }
                    } else if (wordPosInArray !== undefined) {
                        wordHtml = `<span class="ipa-word"><span class="ipa">${ipaArray[wordPosInArray]}</span><span class="original">${wordPart}${punctuationPart}</span></span>`;
                    } else {
                        wordHtml = `${wordPart}${punctuationPart}`;
                    }

                    result += wordHtml + spacePart.replace(/\s/g, '&nbsp;');
                    i += fullToken.length;
                    matched = true;
                }
                
                if (!matched) {
                    const char = text[i];
                    
                    if (char.match(/\s/)) {
                        let spaceEnd = i + 1;
                        while (spaceEnd < text.length && text[spaceEnd].match(/\s/)) {
                            spaceEnd++;
                        }
                        const spaceChunk = text.slice(i, spaceEnd);
                        result += spaceChunk.replace(/\n/g, '<br>').replace(/\s/g, '&nbsp;');
                        i = spaceEnd;
                    } else {
                        result += char.replace(/\n/g, '<br>');
                        i++;
                    }
                }
            }

            result = result.trimEnd().replace(/&nbsp;$/g, '');

            textContent.innerHTML = result;
        }

        function initializeTextContent() {
            renderText(textContentData[0]); // Ch·ªâ d√πng segment ƒë·∫ßu ti√™n cho v√≠ d·ª• n√†y
            applyPadding();
        }

        // --- Audio Control Logic ---

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimeDisplay(displayElement) {
            displayElement.textContent = formatTime(audioPlayer.currentTime);
        }

        let customLoopStart = null;
        let customLoopEnd = null;
        let clickCount = 0;
        let isLooping = false;

        const updateInterval = setInterval(() => updateTimeDisplay(timeDisplay), 1000);

        audioPlayer.ontimeupdate = function() {
            updateTimeDisplay(timeDisplay);
            if (isLooping && customLoopStart !== null && customLoopEnd !== null) {
                if (audioPlayer.currentTime >= customLoopEnd) {
                    audioPlayer.currentTime = customLoopStart;
                }
            }
        };

        timeDisplay.onclick = () => {
            if (audioPlayer.paused) {
                clickCount++;
                if (clickCount === 1) {
                    customLoopStart = audioPlayer.currentTime;
                    loopStart.textContent = formatTime(customLoopStart);
                } else if (clickCount === 2) {
                    customLoopEnd = audioPlayer.currentTime;
                    if (customLoopEnd <= customLoopStart) {
                        customLoopEnd = null;
                        loopEnd.textContent = "--:--";
                    } else {
                        loopEnd.textContent = formatTime(customLoopEnd);
                    }
                    clickCount = 0;
                }
            }
        };

        rewind5sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                updateTimeDisplay(timeDisplay);
            }
        };
        rewind1sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 1);
                updateTimeDisplay(timeDisplay);
            }
        };
        forward1sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 1);
                updateTimeDisplay(timeDisplay);
            }
        };
        forward5sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
                updateTimeDisplay(timeDisplay);
            }
        };

        pausePlayButton.onclick = () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                pausePlayButton.textContent = "ÂÅú";
            } else {
                audioPlayer.pause();
                pausePlayButton.textContent = "Êí≠";
            }
        };

        loopButton.onclick = () => {
            if (customLoopStart !== null && customLoopEnd !== null) {
                audioPlayer.currentTime = customLoopStart;
                audioPlayer.play();
                isLooping = true;
                rewind5sButton.disabled = true;
                rewind1sButton.disabled = true;
                forward1sButton.disabled = true;
                forward5sButton.disabled = true;
            }
        };

        clearButton.onclick = () => {
            customLoopStart = null;
            customLoopEnd = null;
            loopStart.textContent = "--:--";
            loopEnd.textContent = "--:--";
            clickCount = 0;
            isLooping = false;
            rewind5sButton.disabled = false;
            rewind1sButton.disabled = false;
            forward1sButton.disabled = false;
            forward5sButton.disabled = false;
        };
        
        // --- LOGIC N√öT THU G·ªåN/HI·ªÇN TH·ªä C√ì L∆ØU TR·∫†NG TH√ÅI ---

        // N√∫t 'Ëóè' (Thu g·ªçn)
        toggleControlsButton.onclick = () => {
            isControlsHidden = true;
            updateAudioControlsDisplay();
        };

        // N√∫t 'Á§∫' (Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß)
        showControlsButton.onclick = () => {
            isControlsHidden = false;
            updateAudioControlsDisplay();
        };


        audioPlayer.onpause = audioPlayer.onended = function() {
            pausePlayButton.textContent = "Êí≠";
        };


        // =================================================================================
        //                                      PH·∫¶N VOCAB MODE (Luy·ªán t·ª´)
        // =================================================================================
        
        function initializeVocabMode() {
            if (uniqueVocab.length === 0) {
                vocabIndexSpan.textContent = "No words";
                return;
            }
            if (currentVocabIndex >= uniqueVocab.length) currentVocabIndex = 0;
            if (currentVocabIndex < 0) currentVocabIndex = uniqueVocab.length - 1;
            
            selectedLetters = [];
            isChecking = false;
            selectedLettersDiv.className = 'vocab-box'; // Reset class
            
            const currentWord = uniqueVocab[currentVocabIndex];
            const currentIPA = wordToIPA[currentWord] || 'N/A';
            
            vocabIndexSpan.textContent = `${currentVocabIndex + 1}/${uniqueVocab.length}`;
            ipaDisplayVocab.textContent = currentIPA;
            
            const letters = currentWord.split('');
            const shuffledLetters = shuffleArray(letters);
            
            renderLetterPool(shuffledLetters);
            renderSelectedLetters();
        }

        // C·∫£i ti·∫øn: Th√™m ID duy nh·∫•t v√† logic h·ªßy ch·ªçn khi click l·∫°i v√†o Pool
        function renderLetterPool(letters) {
            letterPoolDiv.innerHTML = '';
            letters.forEach((letter, index) => {
                const btn = document.createElement('div');
                btn.className = 'letter-btn';
                btn.textContent = letter;
                // Th√™m ID duy nh·∫•t ƒë·ªÉ theo d√µi, k·ªÉ c·∫£ v·ªõi k√Ω t·ª± tr√πng l·∫∑p
                btn.dataset.poolId = `pool-${index}`;
                
                btn.onclick = () => {
                    // Y√äU C·∫¶U: Nh·∫•n v√†o n√∫t ƒë√£ m·ªù trong pool ƒë·ªÉ h·ªßy ch·ªçn
                    if (btn.classList.contains('used')) {
                        removeLetterFromPool(btn.dataset.poolId);
                    } else {
                        // Ch·ªçn k√Ω t·ª± m·ªõi
                        selectLetter(letter, btn);
                    }
                };
                letterPoolDiv.appendChild(btn);
            });
        }

        // C·∫£i ti·∫øn: L∆∞u ID c·ªßa n√∫t Pool ƒë√£ d√πng
        function selectLetter(letter, btn) {
            // Ch·ªâ th√™m n·∫øu n√∫t ch∆∞a ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† 'used' (m·∫∑c d√π ƒë√£ b·ªè pointer-events: none, ta v·∫´n c·∫ßn ki·ªÉm tra)
            if (btn.classList.contains('used')) return; 

            selectedLetters.push({ 
                letter: letter, 
                poolId: btn.dataset.poolId // L∆ØU ID DUY NH·∫§T
            });
            btn.classList.add('used');
            renderSelectedLetters();
            selectedLettersDiv.classList.remove('correct', 'wrong');
        }

        // C·∫£i ti·∫øn: N√∫t Answer g·ªçi h√†m h·ªßy ch·ªçn b·∫±ng Index
        function renderSelectedLetters() {
            selectedLettersDiv.innerHTML = '';
            selectedLetters.forEach((item, index) => {
                const btn = document.createElement('div');
                btn.className = 'letter-btn letter-btn-in-answer';
                btn.textContent = item.letter;
                // Answer button click: call removeLetterByIndex with the index
                // Y√äU C·∫¶U: Cho ph√©p h·ªßy b·∫•t c·ª© k√Ω t·ª± n√†o trong ph·∫ßn tr·∫£ l·ªùi
                btn.onclick = () => removeLetterByIndex(index); 
                selectedLettersDiv.appendChild(btn);
            });
            
            if (selectedLetters.length === uniqueVocab[currentVocabIndex].length && !isChecking) {
                isChecking = true;
                setTimeout(checkVocabAnswer, 200);
            }
        }
        
        // H√ÄM M·ªöI: H·ªßy ch·ªçn t·ª´ Answer Box (index)
        function removeLetterByIndex(index) {
            // 1. L·∫•y object b·ªã x√≥a v√† x√≥a kh·ªèi m·∫£ng
            const removedItem = selectedLetters.splice(index, 1)[0]; 
            
            // 2. T√¨m n√∫t g·ªëc trong Pool b·∫±ng poolId v√† k√≠ch ho·∫°t l·∫°i
            const originalPoolBtn = document.querySelector(`#letterPool .letter-btn[data-pool-id="${removedItem.poolId}"]`);
            
            if (originalPoolBtn) {
                 originalPoolBtn.classList.remove('used');
            }

            // 3. Render l·∫°i v√† reset tr·∫°ng th√°i
            isChecking = false;
            renderSelectedLetters(); 
            selectedLettersDiv.classList.remove('correct', 'wrong');
        }

        // H√ÄM M·ªöI: H·ªßy ch·ªçn t·ª´ Pool (poolId)
        function removeLetterFromPool(poolId) {
            // T√¨m index c·ªßa k√Ω t·ª± ƒë·∫ßu ti√™n trong selectedLetters c√≥ poolId n√†y
            const indexToRemove = selectedLetters.findIndex(item => item.poolId === poolId);
            
            if (indexToRemove !== -1) {
                // S·ª≠ d·ª•ng h√†m h·ªßy ch·ªçn ƒë√£ t·∫°o (c≈©ng s·∫Ω k√≠ch ho·∫°t l·∫°i n√∫t Pool)
                removeLetterByIndex(indexToRemove);
            }
        }
        
        // --- LOGIC C≈® (ƒê√£ b·ªã lo·∫°i b·ªè) ---
        // function removeLetter(index, originalText) { ... }


        function checkVocabAnswer() {
            const userAnswer = selectedLetters.map(item => item.letter).join('');
            const correctAnswer = uniqueVocab[currentVocabIndex];
            
            if (userAnswer === correctAnswer) {
                selectedLettersDiv.classList.add('correct');
                correctAudio.currentTime = 0; 
                correctAudio.play(); 
            } else {
                selectedLettersDiv.classList.add('wrong');
                wrongAudio.currentTime = 0; 
                wrongAudio.play(); 
            }
            
            setTimeout(() => {
                if (userAnswer === correctAnswer) {
                    vocabNext();
                } else {
                    // N·∫øu sai, reset l·∫°i b√†i hi·ªán t·∫°i
                    initializeVocabMode();
                }
            }, 300); 
        }

        function vocabNext() {
            currentVocabIndex++;
            if (currentVocabIndex >= uniqueVocab.length) {
                currentVocabIndex = 0; 
            }
            initializeVocabMode();
        }

        function vocabPrev() {
            currentVocabIndex--;
            if (currentVocabIndex < 0) {
                currentVocabIndex = uniqueVocab.length - 1;
            }
            initializeVocabMode();
        }

        vocabNextBtn.onclick = vocabNext;
        vocabPrevBtn.onclick = vocabPrev;

        vocabReplayBtn.onclick = () => {
            alert("T√≠nh nƒÉng ph√°t √¢m t·ª´ng t·ª´ c·∫ßn API ho·∫∑c file audio ri√™ng cho t·ª´: " + uniqueVocab[currentVocabIndex]);
        };


        // =================================================================================
        //                                      KH·ªûI T·∫†O V√Ä EVENT LISTENER
        // =================================================================================

        contentModeBtn.addEventListener('click', () => switchMode('reading'));
        vocabModeBtn.addEventListener('click', () => switchMode('vocab'));

        initializeTextContent();
        // C·∫≠p nh·∫≠t: Kh·ªüi t·∫°o tr·∫°ng th√°i b·∫£o l∆∞u audio v√† cu·ªôn
        isControlsHidden = true; 
        updateAudioControlsDisplay(); 
        
        switchMode('reading'); // Kh·ªüi ƒë·ªông ·ªü ch·∫ø ƒë·ªô "N·ªôi dung" m·∫∑c ƒë·ªãnh
    </script>
</body>
</html>